<!doctype html>
<html lang="en">
<head>
  	<meta charset="utf-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  	<title>Huffman Code</title>
  	<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  	<style type="text/css">
    	
    </style>
</head>
<body>

	<div class="container my-3">

		<h1 class="text-center mb-5">Huffman code tool online</h1>

		<ul class="nav nav-tabs">
		  <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#dictionnaryTab">Dictionnary</a></li>
		  <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#encryptTab">Encrypt</a></li>
		  <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#decryptTab">Decrypt</a></li>
		</ul>

	</div>

	<div class="tab-content">

		<div class="container tab-pane fade show active" id="dictionnaryTab">
	  
			<div class="card">
				<h4 class="card-header">Dictionnary</h4>
				<div class="card-body">
				  	<form id="dict" class="">
				  		<div id="inputsValues"></div>
				  		<div class="form-group w-25 collapse mb-0" id="dictNameCollapse">
				  			<input type="text" class="form-control d-block" id="dictName" placeholder="Dictionnary name" />
				  		</div>
				  		<input class="btn btn-primary mt-2" id="submitDict" type="submit" value="Create list" disabled="disabled" />
				  		<input class="btn btn-success mt-2" id="saveDict" type="button" value="Save dictionnary" disabled="disabled" data-toggle="collapse" data-target="#dictNameCollapse" />
				  	</form>
				  </div>
			</div>

		  	<div class="card mt-3">
		  		<h4 class="card-header"><a href="#dictCodesCollapse" data-toggle="collapse" id="toggleJsonDict">Codes</a></h4>
		  		<div class="collapse" id="dictCodesCollapse">
		  			<div class="card-body" id="dictCodes">Not yet calculated.</div>
		  		</div>
		  	</div>

	  	</div>

	  	<div class="container tab-pane fade" id="encryptTab"></div>
	  	<div class="container tab-pane fade" id="decryptTab"></div>

  	</div>

	<script src="jquery-3.2.1.min.js"></script>
	<script src="popper.min.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript">
		
		var inputs = 1;
		
		var divInput = '<div class="form-group form-row"><div class="col" data-content="Character missing" data-placement="left"><input type="text" class="carinput form-control form-control-sm" placeholder="Character"></div><div class="col" data-content="Weight missing" data-placement="right"><input type="number" class="occinput form-control form-control-sm" min="0" max="100" step="any" placeholder="Weight"><div></div>';

		var jsonDict = '[[99.97,[40.28,[17.3,[8.4,"a"],[8.9,[4.18,"d"],[4.72,[2.18,[1.06,"b"],[1.12,"f"]],[2.54,[1.27,"g"],[1.27,[0.51,[0.21,[0.09,[0.04,"w"],[0.05,"k"]],[0.12,"z"]],[0.3,"y"]],[0.76,[0.31,"j"],[0.45,"x"]]]]]]],[22.98,[11,[5.26,"o"],[5.74,"u"]],[11.98,[5.97,[2.96,"m"],[3.01,"p"]],[6.01,"l"]]]],[59.69,[27.01,[12.81,[6.26,[3.03,"c"],[3.23,[1.32,"v"],[1.91,[0.92,"h"],[0.99,"q"]]]],[6.55,"r"]],[14.2,[7.07,"t"],[7.13,"n"]]],[32.68,[15.42,[7.34,"i"],[8.08,"s"]],[17.26,"e"]]]]]';

		var codes;

		$('#inputsValues').append(divInput);

		$('[data-toggle]').popover();

		function manageStorage(key, string=""){
			if(string){
				localStorage.setItem(key, string);
				return true;
			}else{
				var value;
				if(value = localStorage.getItem(key)){
					return value;
				}else{
					return false;
				}
			}
		}

		function saveDict(dict, label){
			var dictListName = "dictList";
			dict = JSON.stringify(dict);
			manageStorage(label, dict);
			var dictList;
			console.log("Dictionnary saved.")
			if(dictList = manageStorage(dictListName)){
				dictList = dictList.split(".");
				if(dictList.indexOf(label) == -1){
					dictList.push(label);
					dictList = dictList.join(".");
					manageStorage(dictListName, dictList);
					console.log("New key added in dictionnary list.");
				}
			}else{
				manageStorage(dictListName, label);
				console.log("No previous dictionnary list existed. Created a new one.");
			}
		}

		function removeDict(label){
			localStorage.removeItem(label);
		}

		function isFieldEmpty(item){
			if(item.val()){
				return false;
			}else{
				return true;
			}
		}

		function createCodeFromTree(tree){

			var codes = {};

			function seekInBranch(node, code){

				if(Array.isArray(node[1])){
					seekInBranch(node[1], (code+"1"));
				}else{
					codes[node[1]] = code;
					console.log(`Found character, adding "${code}" for ${node[1]}`);
				}

				if(node[2]){

					if(Array.isArray(node[2])){
						seekInBranch(node[2], (code+"0"));
					}else{
						codes[node[2]] = code;
						console.log(`Found character, adding "${code} for ${node[2]}"`);
					}

				}

			}

			seekInBranch(tree[0], "");

			console.log(`Codes: ${JSON.stringify(codes)}`);
			return codes;

		}

		function createTreeFromArray(table){

			var decimals = 4;

			table.sort(function(a,b){
				return a[0]-b[0];
			});

			var i = 0;
			var iterateMax = table.length;
			console.log(`Iterations max : ${iterateMax}`);
			
			while(table.length > 1 && i <= iterateMax){
				var newWeight = parseFloat((table[0][0] + table[1][0]).toFixed(decimals));
				var newNode = [newWeight, table[0], table[1]];
				table.push(newNode);
				table.splice(0,2);
				table.sort(function(a,b){
					return a[0]-b[0];
				});
				i++;
			}

			console.log(`Tree: ${JSON.stringify(table)}`);
			return table;

		}

		function checkInputs(){
			
			var results = [];
			
			$('#inputsValues > div').each(function(){
				if(!isFieldEmpty($(this).find(".carinput")) && !isFieldEmpty($(this).find(".occinput"))){
					var car = $(this).find("div > .carinput").val();
					var occ = parseFloat($(this).find("div > .occinput").val());
					results.push([occ, car]);
				}else if(!isFieldEmpty($(this).find(".carinput"))){
					$(this).find(".occinput").addClass("is-invalid");
					$(this).find(".occinput").parent().popover("show");
				}else if(!isFieldEmpty($(this).find(".occinput"))){
					$(this).find(".carinput").addClass("is-invalid");
					$(this).find(".carinput").parent().popover("show");
				}
			});

			console.log(`${JSON.stringify(results)} : ${results.length} items`);
			return results;
		}

		function manageInputs(item){

			if(isFieldEmpty(item.find(".carinput")) && isFieldEmpty(item.find(".occinput")) && inputs > 1){
				item.remove();
				inputs--;
			}else if(item.is(":last-child")){
				item.parent().append(divInput);
				inputs++;
			}
			console.log(`${inputs} inputs.`);

			manageSubmitDict();

		}

		function manageSubmitDict(){

			if(inputs > 1){
				$('#submitDict').removeAttr("disabled");
				console.log("Enabling submit dictionnary button");
			}else{
				$('#submitDict').attr("disabled", "disabled");
				console.log("Disabling submit dictionnary button");
			}

		}

		function createHtmlTableFromObject(obj){
			var html = $("<table></table>");
			html.addClass("table table-striped table-condensed");
			html.html("<thead><tr><th>Character</th><th>Code</th></tr></thead><tbody></tbody>");
			html.find("thead").addClass("thead-light");
			for(var key in obj){
				html.children("tbody").append(`<tr><td>"${key}"</td><td>${obj[key]}</td></tr>`);
			}
			return html;
		}

		$('body').on('change', 'input.carinput, input.occinput', function(){
			manageInputs($(this).parent().parent());
			if(!isFieldEmpty($(this))){
				$(this).parent().popover("hide");
				$(this).parent().parent().find(".is-invalid").removeClass("is-invalid");
			}
		});

		$('#dict').on('submit', function(event){
			event.preventDefault();

			var results = checkInputs();
			
			results = createTreeFromArray(results);
			if(results.length > 0){

				codes = createCodeFromTree(results);
				$('#dictCodes').html(createHtmlTableFromObject(codes));

				$('#saveDict').removeAttr("disabled");
				$('#dictCodesCollapse').collapse("show");

			}

		});

		$('#dictNameCollapse').on('hide.bs.collapse', function(){
			var userDictName = $('#dictName').val();
			$('#dictName').val("");
			saveDict(codes, userDictName);
		});

		$('#dictNameCollapse').on('shown.bs.collapse', function(){
			$('#dictName').focus();
		});

	</script>
</body>
</html>