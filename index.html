<!doctype html>
<html lang="en">
<head>
  	<meta charset="utf-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  	<title>Huffman Code</title>
  	<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  	<style type="text/css">
    	
    </style>
</head>
<body>

	<div class="container">

		<h1>Huffman code tool online</h1>
  
	  	<form id="dict" class="well well-sm">
	  		<legend>Dictionnary</legend>
	  		<div id="inputsValues"></div>
	  		<input class="btn btn-primary" id="submitDict" type="submit" value="Create list" disabled="disabled" />
	  		<input class="btn btn-success" id="saveDict" type="button" value="Save dictionnary" disabled="disabled" data-toggle="popover" data-content="Not working now" />
	  	</form>

	  	<div class="panel panel-default">
	  		<div class="panel-heading" id="jsonDictTitle"><h4>Tree Results JSON</h4></div>
	  		<div class="panel-body"><div id="jsonDict" class="collapse">Not yet calculated.</div><a href="#jsonDict" data-toggle="collapse" class="btn btn-default" id="toggleJsonDict">Toggle</a></div>
	  		<div class="panel-heading"><h4>Codes</h4></div>
	  		<div class="panel-body"><div class="collapse" id="dictCodes">Not yet calculated.</div><a href="#dictCodes" data-toggle="collapse" class="btn btn-default" id="toggleJsonDict">Toggle</a></div>
	  	</div>

  	</div>

	<script src="jquery-3.2.1.min.js"></script>
	<script src="popper.min.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript">
		
		var inputs = 1;
		
		var divInput = '<div class="form-group row"><div class="col-md-6" data-content="Character missing" data-placement="left"><input type="text" class="carinput form-control input-sm" placeholder="Character"></div><div class="col-md-6" data-content="Weight missing" data-placement="right"><input type="number" class="occinput form-control input-sm" min="0" max="100" step="any" placeholder="Weight"><div></div>';

		var jsonDict = '[[99.97,[40.28,[17.3,[8.4,"a"],[8.9,[4.18,"d"],[4.72,[2.18,[1.06,"b"],[1.12,"f"]],[2.54,[1.27,"g"],[1.27,[0.51,[0.21,[0.09,[0.04,"w"],[0.05,"k"]],[0.12,"z"]],[0.3,"y"]],[0.76,[0.31,"j"],[0.45,"x"]]]]]]],[22.98,[11,[5.26,"o"],[5.74,"u"]],[11.98,[5.97,[2.96,"m"],[3.01,"p"]],[6.01,"l"]]]],[59.69,[27.01,[12.81,[6.26,[3.03,"c"],[3.23,[1.32,"v"],[1.91,[0.92,"h"],[0.99,"q"]]]],[6.55,"r"]],[14.2,[7.07,"t"],[7.13,"n"]]],[32.68,[15.42,[7.34,"i"],[8.08,"s"]],[17.26,"e"]]]]]';

		$('#inputsValues').append(divInput);

		$('[data-toggle]').popover()

		function isFieldEmpty(item){
			if(item.val()){
				return false;
			}else{
				return true;
			}
		}

		function createCodeFromTree(tree){

			var codes = {};

			function seekInBranch(node, code){

				if(Array.isArray(node[1])){
					seekInBranch(node[1], (code+"1"));
				}else{
					codes[node[1]] = code;
					console.log(`Found character, adding "${code}" for ${node[1]}`);
				}

				if(node[2]){

					if(Array.isArray(node[2])){
						seekInBranch(node[2], (code+"0"));
					}else{
						codes[node[2]] = code;
						console.log(`Found character, adding "${code} for ${node[2]}"`);
					}

				}

			}

			seekInBranch(tree[0], "");

			console.log(`Codes: ${JSON.stringify(codes)}`);
			return codes;

		}

		function createTreeFromArray(table){

			var decimals = 4;

			table.sort(function(a,b){
				return a[0]-b[0];
			});

			var i = 0;
			var iterateMax = table.length;
			console.log(`Iterations max : ${iterateMax}`);
			
			while(table.length > 1 && i <= iterateMax){
				var newWeight = parseFloat((table[0][0] + table[1][0]).toFixed(decimals));
				var newNode = [newWeight, table[0], table[1]];
				table.push(newNode);
				table.splice(0,2);
				table.sort(function(a,b){
					return a[0]-b[0];
				});
				i++;
			}

			console.log(`Tree: ${JSON.stringify(table)}`);
			return table;

		}

		function checkInputs(){
			
			var results = [];
			
			$('#inputsValues > div').each(function(){
				if(!isFieldEmpty($(this).find(".carinput")) && !isFieldEmpty($(this).find(".occinput"))){
					var car = $(this).find("div > .carinput").val();
					var occ = parseFloat($(this).find("div > .occinput").val());
					results.push([occ, car]);
				}else if(!isFieldEmpty($(this).find(".carinput"))){
					$(this).find(".carinput").parent().addClass("has-warning");
					$(this).find(".occinput").parent().popover("show");
				}else if(!isFieldEmpty($(this).find(".occinput"))){
					$(this).find(".occinput").parent().addClass("has-warning");
					$(this).find(".carinput").parent().popover("show");
				}
			});

			console.log(`${JSON.stringify(results)} : ${results.length} items`);
			return results;
		}

		function manageInputs(item){

			if(isFieldEmpty(item.find(".carinput")) && isFieldEmpty(item.find(".occinput")) && inputs > 1){
				item.remove();
				inputs--;
			}else if(item.is(":last-child")){
				item.parent().append(divInput);
				inputs++;
			}
			console.log(`${inputs} inputs.`);

			manageSubmitDict();

		}

		function manageSubmitDict(){

			if(inputs > 1){
				$('#submitDict').removeAttr("disabled");
				console.log("Enabling submit dictionnary button");
			}else{
				$('#submitDict').attr("disabled", "disabled");
				console.log("Disabling submit dictionnary button");
			}

		}

		function createHtmlTableFromObject(obj){
			var html = $("<table></table>");
			html.addClass("table table-striped table-condensed");
			html.html("<thead><tr><th>Character</th><th>Code</th></tr></thead><tbody></tbody>");
			for(var key in obj){
				html.children("tbody").append(`<tr><td>"${key}"</td><td>${obj[key]}</td></tr>`);
			}
			return html;
		}

		$('body').on('change', 'input.carinput, input.occinput', function(){
			manageInputs($(this).parent().parent());
			if(!isFieldEmpty($(this))){
				$(this).parent().popover("hide");
				$(this).parent().parent().find(".has-warning").removeClass("has-warning");
			}
		});

		$('#dict').on('submit', function(event){
			event.preventDefault();

			var results = checkInputs();
			
			results = createTreeFromArray(results);
			if(results.length > 0){
				
				$("#jsonDict").text(JSON.stringify(results));

				var codes = createCodeFromTree(results);
				$('#dictCodes').html(createHtmlTableFromObject(codes));

				$('#saveDict').removeAttr("disabled");
			}

		});

	</script>
</body>
</html>